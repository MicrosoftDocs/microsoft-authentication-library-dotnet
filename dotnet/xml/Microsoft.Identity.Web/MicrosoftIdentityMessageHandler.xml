<Type Name="MicrosoftIdentityMessageHandler" FullName="Microsoft.Identity.Web.MicrosoftIdentityMessageHandler">
  <TypeSignature Language="C#" Value="public class MicrosoftIdentityMessageHandler : System.Net.Http.DelegatingHandler" />
  <TypeSignature Language="ILAsm" Value=".class public auto ansi beforefieldinit MicrosoftIdentityMessageHandler extends System.Net.Http.DelegatingHandler" />
  <TypeSignature Language="DocId" Value="T:Microsoft.Identity.Web.MicrosoftIdentityMessageHandler" />
  <TypeSignature Language="VB.NET" Value="Public Class MicrosoftIdentityMessageHandler&#xA;Inherits DelegatingHandler" />
  <TypeSignature Language="F#" Value="type MicrosoftIdentityMessageHandler = class&#xA;    inherit DelegatingHandler" />
  <AssemblyInfo>
    <AssemblyName>Microsoft.Identity.Web.TokenAcquisition</AssemblyName>
    <AssemblyVersion>4.0.0.0</AssemblyVersion>
    <AssemblyVersion>4.0.1.0</AssemblyVersion>
    <AssemblyVersion>4.1.0.0</AssemblyVersion>
    <AssemblyVersion>4.1.1.0</AssemblyVersion>
  </AssemblyInfo>
  <Base>
    <BaseTypeName>System.Net.Http.DelegatingHandler</BaseTypeName>
  </Base>
  <Interfaces />
  <Attributes>
    <Attribute>
      <AttributeName Language="C#">[System.Runtime.CompilerServices.Nullable(0)]</AttributeName>
      <AttributeName Language="F#">[&lt;System.Runtime.CompilerServices.Nullable(0)&gt;]</AttributeName>
    </Attribute>
  </Attributes>
  <Docs>
    <summary>
            A <see cref="T:System.Net.Http.DelegatingHandler" /> implementation that automatically adds authorization headers 
            to outgoing HTTP requests using <see cref="T:Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider" /> and 
            <see cref="T:Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions" />.
            </summary>
    <remarks>
      <para>
            This message handler provides a flexible, composable way to add Microsoft Identity authentication 
            to HttpClient-based code. It serves as an alternative to <c>IDownstreamApi</c> for scenarios where
            developers want to maintain direct control over HTTP request handling while still benefiting from
            Microsoft Identity Web's authentication capabilities.
            </para>
      <para>
        <strong>Key Features:</strong>
      </para>
      <list type="bullet">
        <item>
          <description>Automatic authorization header injection for all outgoing requests</description>
        </item>
        <item>
          <description>Per-request authentication options using extension methods</description>
        </item>
        <item>
          <description>Automatic WWW-Authenticate challenge handling with token refresh</description>
        </item>
        <item>
          <description>Support for agent identity and managed identity scenarios</description>
        </item>
        <item>
          <description>Comprehensive logging and error handling</description>
        </item>
        <item>
          <description>Multi-framework compatibility (.NET Framework 4.6.2+, .NET Standard 2.0+, .NET 5+)</description>
        </item>
      </list>
      <para>
        <strong>WWW-Authenticate Challenge Handling:</strong>
      </para>
      <para>
            When a downstream API returns a 401 Unauthorized response with a WWW-Authenticate header containing
            Bearer challenges with additional claims, this handler will automatically attempt to acquire a new token
            with the requested claims and retry the request. This is particularly useful for Conditional Access
            scenarios where additional claims are required.
            </para>
    </remarks>
    <altmember cref="T:Microsoft.Identity.Web.HttpRequestMessageAuthenticationExtensions" />
    <altmember cref="T:Microsoft.Identity.Web.MicrosoftIdentityAuthenticationException" />
    <altmember cref="T:Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider" />
    <example>
      <para>
        <strong>Basic setup with dependency injection:</strong>
      </para>
      <code>
            // In Program.cs or Startup.cs
            services.AddHttpClient("MyApiClient", client =&gt;
            {
                client.BaseAddress = new Uri("https://api.example.com");
            })
            .AddHttpMessageHandler(serviceProvider =&gt; new MicrosoftIdentityMessageHandler(
                serviceProvider.GetRequiredService&lt;IAuthorizationHeaderProvider&gt;(),
                new MicrosoftIdentityMessageHandlerOptions 
                { 
                    Scopes = { "https://api.example.com/.default" }
                }));
            
            // In a controller or service
            public class ApiService
            {
                private readonly HttpClient _httpClient;
                
                public ApiService(IHttpClientFactory httpClientFactory)
                {
                    _httpClient = httpClientFactory.CreateClient("MyApiClient");
                }
                
                public async Task&lt;string&gt; GetDataAsync()
                {
                    var response = await _httpClient.GetAsync("/api/data");
                    response.EnsureSuccessStatusCode();
                    return await response.Content.ReadAsStringAsync();
                }
            }
            </code>
      <para>
        <strong>Per-request authentication options:</strong>
      </para>
      <code>
            // Override scopes for a specific request
            var request = new HttpRequestMessage(HttpMethod.Get, "/api/sensitive-data")
                .WithAuthenticationOptions(options =&gt;
                {
                    options.Scopes.Add("https://api.example.com/sensitive.read");
                    options.RequestAppToken = true;
                });
            
            var response = await _httpClient.SendAsync(request);
            </code>
      <para>
        <strong>Agent identity usage:</strong>
      </para>
      <code>
            var request = new HttpRequestMessage(HttpMethod.Get, "/api/agent-data")
                .WithAuthenticationOptions(options =&gt;
                {
                    options.Scopes.Add("https://graph.microsoft.com/.default");
                    options.WithAgentIdentity("agent-application-id");
                    options.RequestAppToken = true;
                });
            
            var response = await _httpClient.SendAsync(request);
            </code>
      <para>
        <strong>Manual instantiation:</strong>
      </para>
      <code>
            var headerProvider = serviceProvider.GetRequiredService&lt;IAuthorizationHeaderProvider&gt;();
            var logger = serviceProvider.GetService&lt;ILogger&lt;MicrosoftIdentityMessageHandler&gt;&gt;();
            
            var handler = new MicrosoftIdentityMessageHandler(
                headerProvider, 
                new MicrosoftIdentityMessageHandlerOptions 
                { 
                    Scopes = { "https://graph.microsoft.com/.default" }
                },
                logger);
            
            using var httpClient = new HttpClient(handler);
            var response = await httpClient.GetAsync("https://graph.microsoft.com/v1.0/me");
            </code>
      <para>
        <strong>Error handling:</strong>
      </para>
      <code>
            try
            {
                var response = await _httpClient.SendAsync(request, cancellationToken);
                response.EnsureSuccessStatusCode();
                return await response.Content.ReadAsStringAsync();
            }
            catch (MicrosoftIdentityAuthenticationException authEx)
            {
                // Handle authentication-specific failures
                _logger.LogError(authEx, "Authentication failed: {Message}", authEx.Message);
                throw;
            }
            catch (HttpRequestException httpEx)
            {
                // Handle other HTTP failures
                _logger.LogError(httpEx, "HTTP request failed: {Message}", httpEx.Message);
                throw;
            }
            </code>
    </example>
    <altmember cref="T:Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions" />
  </Docs>
  <Members>
    <Member MemberName=".ctor">
      <MemberSignature Language="C#" Value="public MicrosoftIdentityMessageHandler (Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider headerProvider, Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions? defaultOptions = default, Microsoft.Extensions.Logging.ILogger&lt;Microsoft.Identity.Web.MicrosoftIdentityMessageHandler&gt;? logger = default);" />
      <MemberSignature Language="ILAsm" Value=".method public hidebysig specialname rtspecialname instance void .ctor(class Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider headerProvider, class Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions defaultOptions, class Microsoft.Extensions.Logging.ILogger`1&lt;class Microsoft.Identity.Web.MicrosoftIdentityMessageHandler&gt; logger) cil managed" />
      <MemberSignature Language="DocId" Value="M:Microsoft.Identity.Web.MicrosoftIdentityMessageHandler.#ctor(Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider,Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions,Microsoft.Extensions.Logging.ILogger{Microsoft.Identity.Web.MicrosoftIdentityMessageHandler})" />
      <MemberSignature Language="VB.NET" Value="Public Sub New (headerProvider As IAuthorizationHeaderProvider, Optional defaultOptions As MicrosoftIdentityMessageHandlerOptions = Nothing, Optional logger As ILogger(Of MicrosoftIdentityMessageHandler) = Nothing)" />
      <MemberSignature Language="F#" Value="new Microsoft.Identity.Web.MicrosoftIdentityMessageHandler : Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider * Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions * Microsoft.Extensions.Logging.ILogger&lt;Microsoft.Identity.Web.MicrosoftIdentityMessageHandler&gt; -&gt; Microsoft.Identity.Web.MicrosoftIdentityMessageHandler" Usage="new Microsoft.Identity.Web.MicrosoftIdentityMessageHandler (headerProvider, defaultOptions, logger)" />
      <MemberType>Constructor</MemberType>
      <AssemblyInfo>
        <AssemblyName>Microsoft.Identity.Web.TokenAcquisition</AssemblyName>
        <AssemblyVersion>4.1.1.0</AssemblyVersion>
      </AssemblyInfo>
      <Parameters>
        <Parameter Name="headerProvider" Type="Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider" />
        <Parameter Name="defaultOptions" Type="Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions">
          <Attributes>
            <Attribute>
              <AttributeName Language="C#">[System.Runtime.CompilerServices.Nullable(2)]</AttributeName>
              <AttributeName Language="F#">[&lt;System.Runtime.CompilerServices.Nullable(2)&gt;]</AttributeName>
            </Attribute>
          </Attributes>
        </Parameter>
        <Parameter Name="logger" Type="Microsoft.Extensions.Logging.ILogger&lt;Microsoft.Identity.Web.MicrosoftIdentityMessageHandler&gt;">
          <Attributes>
            <Attribute>
              <AttributeName Language="C#">[System.Runtime.CompilerServices.Nullable(new System.Byte[] { 2, 1 })]</AttributeName>
              <AttributeName Language="F#">[&lt;System.Runtime.CompilerServices.Nullable(new System.Byte[] { 2, 1 })&gt;]</AttributeName>
            </Attribute>
          </Attributes>
        </Parameter>
      </Parameters>
      <Docs>
        <param name="headerProvider">
            The <see cref="T:Microsoft.Identity.Abstractions.IAuthorizationHeaderProvider" /> used to acquire authorization headers for outgoing requests.
            This is typically obtained from the dependency injection container.
            </param>
        <param name="defaultOptions">
            Default authentication options that will be used for all requests unless overridden per-request 
            using <see cref="M:Microsoft.Identity.Web.HttpRequestMessageAuthenticationExtensions.WithAuthenticationOptions(System.Net.Http.HttpRequestMessage,Microsoft.Identity.Web.MicrosoftIdentityMessageHandlerOptions)" />.
            If <see langword="null" />, each request must specify its own authentication options or an exception will be thrown.
            </param>
        <param name="logger">
            Optional logger for debugging and monitoring authentication operations. 
            If provided, the handler will log information about token acquisition, challenges, and errors.
            </param>
        <summary>
            Initializes a new instance of the <see cref="T:Microsoft.Identity.Web.MicrosoftIdentityMessageHandler" /> class.
            </summary>
        <remarks>
          <para>
            The <paramref name="defaultOptions" /> parameter provides a convenient way to set authentication
            options that apply to all requests made through this handler instance. Individual requests can 
            still override these defaults using the extension methods.
            </para>
          <para>
            When <paramref name="logger" /> is provided, the handler will log at various levels:
            </para>
          <list type="bullet">
            <item>
              <description>
                <strong>Debug:</strong> Successful authorization header addition</description>
            </item>
            <item>
              <description>
                <strong>Information:</strong> WWW-Authenticate challenge detection and handling</description>
            </item>
            <item>
              <description>
                <strong>Warning:</strong> Challenge handling failures</description>
            </item>
            <item>
              <description>
                <strong>Error:</strong> Token acquisition failures</description>
            </item>
          </list>
        </remarks>
        <exception cref="T:System.ArgumentNullException">
            Thrown when <paramref name="headerProvider" /> is <see langword="null" />.
            </exception>
        <example>
          <para>Basic usage with default options:</para>
          <code>
            var handler = new MicrosoftIdentityMessageHandler(
                headerProvider,
                new MicrosoftIdentityMessageHandlerOptions 
                { 
                    Scopes = { "https://api.example.com/.default" }
                });
            </code>
          <para>Usage without default options (per-request configuration required):</para>
          <code>
            var handler = new MicrosoftIdentityMessageHandler(headerProvider);
            
            // Each request must specify options
            var request = new HttpRequestMessage(HttpMethod.Get, "/api/data")
                .WithAuthenticationOptions(options =&gt; 
                    options.Scopes.Add("custom.scope"));
            </code>
          <para>Usage with logging:</para>
          <code>
            var logger = serviceProvider.GetService&lt;ILogger&lt;MicrosoftIdentityMessageHandler&gt;&gt;();
            var handler = new MicrosoftIdentityMessageHandler(headerProvider, defaultOptions, logger);
            </code>
        </example>
      </Docs>
    </Member>
    <Member MemberName="SendAsync">
      <MemberSignature Language="C#" Value="protected override System.Threading.Tasks.Task&lt;System.Net.Http.HttpResponseMessage&gt; SendAsync (System.Net.Http.HttpRequestMessage request, System.Threading.CancellationToken cancellationToken);" />
      <MemberSignature Language="ILAsm" Value=".method familyhidebysig virtual instance class System.Threading.Tasks.Task`1&lt;class System.Net.Http.HttpResponseMessage&gt; SendAsync(class System.Net.Http.HttpRequestMessage request, valuetype System.Threading.CancellationToken cancellationToken) cil managed" />
      <MemberSignature Language="DocId" Value="M:Microsoft.Identity.Web.MicrosoftIdentityMessageHandler.SendAsync(System.Net.Http.HttpRequestMessage,System.Threading.CancellationToken)" />
      <MemberSignature Language="VB.NET" Value="Protected Overrides Function SendAsync (request As HttpRequestMessage, cancellationToken As CancellationToken) As Task(Of HttpResponseMessage)" />
      <MemberSignature Language="F#" Value="override this.SendAsync : System.Net.Http.HttpRequestMessage * System.Threading.CancellationToken -&gt; System.Threading.Tasks.Task&lt;System.Net.Http.HttpResponseMessage&gt;" Usage="microsoftIdentityMessageHandler.SendAsync (request, cancellationToken)" />
      <MemberType>Method</MemberType>
      <AssemblyInfo>
        <AssemblyName>Microsoft.Identity.Web.TokenAcquisition</AssemblyName>
        <AssemblyVersion>4.1.1.0</AssemblyVersion>
      </AssemblyInfo>
      <ReturnValue>
        <ReturnType>System.Threading.Tasks.Task&lt;System.Net.Http.HttpResponseMessage&gt;</ReturnType>
      </ReturnValue>
      <Parameters>
        <Parameter Name="request" Type="System.Net.Http.HttpRequestMessage" />
        <Parameter Name="cancellationToken" Type="System.Threading.CancellationToken" />
      </Parameters>
      <Docs>
        <param name="request">The HTTP request message to send.</param>
        <param name="cancellationToken">A cancellation token to cancel operation.</param>
        <summary>
            Sends an HTTP request with automatic authentication header injection.
            Handles WWW-Authenticate challenges by attempting token refresh with additional claims if needed.
            </summary>
        <returns>The HTTP response message.</returns>
        <remarks>To be added.</remarks>
        <exception cref="T:Microsoft.Identity.Web.MicrosoftIdentityAuthenticationException">
            Thrown when authentication fails, including scenarios where:
            - No authentication options are configured
            - No scopes are specified in the options
            - Token acquisition fails
            - WWW-Authenticate challenge handling fails
            </exception>
      </Docs>
    </Member>
  </Members>
</Type>
